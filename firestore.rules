rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Fonctions utilitaires ---
    function isAuth() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isAuth() && request.auth.uid == uid;
    }
    function validJanazaFields(data) {
      return data.nom_defunt is string && data.nom_defunt.size() <= 100
          && data.nom_mosquee is string && data.nom_mosquee.size() <= 150
          && data.adresse_mosquee is string && data.adresse_mosquee.size() <= 300
          && data.coordonnees is map
          && data.heure_priere is timestamp;
    }

    // --- Collection: janazas ---
    match /janazas/{janazaId} {
      // Lecture : Publique (prières communautaires)
      allow read: if true;

      // Création : Authentifié + UID correct + champs valides
      allow create: if isAuth()
                    && request.resource.data.created_by == request.auth.uid
                    && validJanazaFields(request.resource.data);

      // Modification : Seulement le créateur + champs valides
      allow update: if isOwner(resource.data.created_by)
                    && validJanazaFields(request.resource.data);

      // Suppression : Seulement le créateur
      allow delete: if isOwner(resource.data.created_by);
    }

    // --- Collection: saved_janazas (Favoris) ---
    match /saved_janazas/{saveId} {
      // Lecture : Uniquement ses propres favoris
      allow read: if isOwner(resource.data.user_id);

      // Création : Authentifié + UID correct
      allow create: if isAuth()
                    && request.resource.data.user_id == request.auth.uid;

      // Modification : Interdite (un favori ne se modifie pas)
      allow update: if false;

      // Suppression : Uniquement ses propres favoris
      allow delete: if isOwner(resource.data.user_id);
    }

    // --- Collection: users ---
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
  }
}
